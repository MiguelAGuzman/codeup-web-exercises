<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>First Mapbox Map</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>
    <!-- Custom CSS -->
    <style>
        h1 {
            display: flex;
            justify-content: center;
        }
        #map {
            /* the width and height may be set to any size */
            width: 100%;
            height: 700px;
        }
        .cards {
            position: center;
            text-align: center;
            width: 200px;
            background-color: lightblue;
            margin: 10px;
        }
        #cardContainer {
            display: flex;
            flex-direction: row;
            justify-content: space-evenly;
            position: center;
        }
        .map-input {
            display: flex;
            justify-content: center;
        }
    </style>
    <script src="js/mapbox-geocoder-utils.js"></script>
</head>
<body>
    <h1>My First Mapbox Map!</h1>

    <div id="cardContainer"></div>

    <br>

    <!-- Load the `mapbox-gl-geocoder` plugin. -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
    <!-- The HTML element that serves as the Mapbox container -->
    <div id='map'></div>
    <!-- Mapbox JS -->
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>
    <!-- Custom JS -->
    <script src="js/keys.js"></script>
    <script>
        (async function () {
            "use strict";

            let newMarker;

            mapboxgl.accessToken = MAPBOX_API_KEY;
            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                zoom: 10,
                center: [-98.4916, 29.4252]
            });

            map.addControl(new mapboxgl.GeolocateControl());
            map.addControl(new mapboxgl.NavigationControl());
            map.addControl(
                new MapboxGeocoder({
                    accessToken: mapboxgl.accessToken,
                    mapboxgl: mapboxgl
                }),
                'top-left'
            );

            let queryParams = new URLSearchParams({
                APPID: WEATHERMAP_API_KEY,
                lat: 29.423017,
                lon: -98.48527,
                units: "imperial"
            });


            const cc = document.getElementById("cardContainer");
            const base = `https://api.openweathermap.org/data/2.5/onecall?${queryParams}`;
            console.log(base);
            fetch(base).then((response) => {
                return response.json()
            }).then((data) => {
                console.log(data);
                for (let i = 0; i < 5; i++) {
                    let date = new Date(data.daily[i].dt * 1000)
                    cc.innerHTML +=
                        `<div class="cards">
                            <div><h1>${date.toDateString()}</h1></div>
                            <div><h1>${data.daily[i].temp.day}°</h1></div>
                            <div><h2>${data.daily[i].weather[0].description}</h2></div>
                            <div><p>Humidity ${data.daily[i].humidity}%</p></div>
                         </div> <br>
                    `;
                }
            });

            // Function to geocode addresses with fetch to mapbox.
            function getLngLatFromAddress(address, token = MAPBOX_API_KEY) {
                const baseUrl = 'https://api.mapbox.com';
                const endPoint = '/geocoding/v5/mapbox.places/';
                return fetch(baseUrl + endPoint + encodeURIComponent(address) + '.json' + "?" + 'access_token=' + token)
                    .then(function (res) {
                        return res.json();
                        // to get all the data from the request, comment out the following three lines...
                    }).then(function (data) {
                        return data.features[0].center;
                    });
            }

            // Various zoom options with buttons and select
            let zoomInBtn = document.getElementById(`zoomIn`);
            zoomInBtn.addEventListener("click", function (event) {
                let currentZoom = map.getZoom();
                currentZoom += 2;
                map.setZoom(currentZoom);
            });
            let zoomOutBtn = document.getElementById(`zoomOut`);
            zoomOutBtn.addEventListener("click", function (event) {
                let currentZoom = map.getZoom();
                currentZoom -= 2;
                map.setZoom(currentZoom);
            });
            let zoomSelect = document.getElementById(`zoomSelect`);
            console.log(`Logging currently selected zoom value: ${zoomSelect.value}`);
            zoomSelect.addEventListener("change", function (event) {
                console.log(zoomSelect.value);
                map.setZoom(zoomSelect.value);
            });

            const currentMarkers = [];
            // Allows user to enter any place or address and have a marker appear on
            // that place.
            // Markers are added to a current marker array for optional removal.
            let searchBtn = document.getElementById(`searchBtn`);
            let searchInput = document.getElementById(`searchInput`);
            searchBtn.addEventListener('click', async function (event) {
                console.log(searchInput.value);
                let searchCoords = (await getLngLatFromAddress(searchInput.value));
                map.setCenter(searchCoords);
                newMarker.remove();
                newMarker = new mapboxgl.Marker({draggable: true});
                newMarker.setLngLat(searchCoords);
                newMarker.addTo(map);
                onDragEnd();
                newMarker.on('dragend', onDragEnd);
                currentMarkers.push(newMarker);
            })

            const input = document.getElementById("searchInput");
            // Execute a function when the user releases a key on the keyboard
            input.addEventListener("keyup", function(event) {
                // Number 13 is the "Enter" key on the keyboard
                if (event.keyCode === 13) {
                    // Cancel the default action, if needed
                    event.preventDefault();
                    // Trigger the button element with a click
                    document.getElementById("searchBtn").click();
                }
            });

            let removeMarkersBtn = document.getElementById(`removeMarkersBtn`);
            removeMarkersBtn.addEventListener("click", function (event) {
                if (currentMarkers !== null) {
                    for (let i = currentMarkers.length - 1; i >= 0; i--) {
                        currentMarkers[i].remove();
                    }
                }
            })

            const coordinates = document.getElementById('coordinates');
            newMarker = new mapboxgl.Marker({
                draggable: true
            })

            function onDragEnd() {
                const lngLat = newMarker.getLngLat();
                console.log(lngLat);
                coordinates.style.display = 'block';
                coordinates.innerHTML = `Longitude: ${lngLat.lng}<br />Latitude: ${lngLat.lat}`;
                map.setCenter(lngLat);
                // OpenWeather API call
                let queryParams = new URLSearchParams({
                    APPID: WEATHERMAP_API_KEY,
                    lat: lngLat.lat,
                    lon: lngLat.lng,
                    units: "imperial"
                });
                console.log(queryParams);
                const url = `https://api.openweathermap.org/data/2.5/onecall?${queryParams}`;
                console.log(url);
                fetch(url)
                    .then(function (response) {
                        return response.json();
                    }).then(function (data) {
                    console.log(data);
                    let weatherDataDiv = document.getElementById(`weatherData`);
                    weatherDataDiv.innerHTML = ""
                    for (let i = 0; i < 5; i++) {
                        weatherDataDiv.innerHTML += `
                            <div class="cards">
                                <div><h1>${date.toDateString()}</h1></div>
                                <div><h1>${data.daily[i].temp.day}°</h1></div>
                                <div><h2>${data.daily[i].weather[0].description}</h2></div>
                                <div><p>Humidity ${data.daily[i].humidity}%</p></div>
                            </div> <br>
                        `
                    }
                });
            }

            newMarker.on('dragend', onDragEnd);


        })();
    </script>
</body>
</html>









